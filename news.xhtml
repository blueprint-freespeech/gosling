<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Gosling | News</title>
  <link rel="icon" type="image/x-icon" href="images/favicon.png" />
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="navigation">
      <div class="logo">
        <a href="index.xhtml"><img src="images/gosling-square-small-opt.svg" alt="Gosling Icon" /></a>
      </div>
      <h2>Navigation</h2>
      <ul>
        <li><a href="news.xhtml">News</a></li>
        <li><a href="https://github.com/blueprint-freespeech/gosling">GitHub</a></li>
        <li><a href="coverage.html">Test Coverage</a></li>
        <li>Crate Docs
          <ul>
            <li><a href="crates/gosling/index.html">gosling</a></li>
            <li><a href="crates/tor_interface/index.html">tor-interface</a></li>
            <li><a href="crates/honk_rpc/index.html">honk-rpc</a></li>
          </ul>
        </li>
        <li><a href="cgosling/index.html">C/C++ Docs</a></li>
        <li>Protocol Specs
          <ul>
            <li><a href="honk-rpc-spec.xhtml">Honk-RPC</a></li>
            <li><a href="gosling-spec.xhtml">Gosling</a></li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="content">
      <h1 id="news">News</h1>
      <hr />
      <h2 id="new-minor-features-and-configuration-options">2024-07-06 - New minor features and configuration options</h2>
      <p>The work for the past month or so has been focused on implementing various features unrelated to the Gosling protocol itself.</p>
      <p>We anticipate developers of gosling-using applications may also want to connect to other third party domains or onion services. To mitigate anonymity and linkability concerns, we have introduced a <code>connect</code> function on the gosling and cgosling interfaces. This will allow developers to connect to domains anonymously through the packaged tor daemon. Some use cases may be for anonymous update pings or for accessing 3rd party services.</p>
      <p>Users or application packagers are also very likely going to want to have the option to use a system tor daemon for their gosling-using applications (rather than launching and managing their own tor instance). To enable this, we have generalised the idea of building a <code>gosling_tor_provider</code> by instead building a <code>gosling_tor_provider_config</code>, and then generating a <code>gosling_tor_provider</code> through that config.</p>
      <p>This change in API surface means we won’t need to worry as much about API breakage if we want to add additional configuration options to an existing tor provider type. The now currently supported config types are:</p>
      <ul>
      <li><strong>bundled legacy tor daemon</strong>: the previous default, and how Ricochet-Refresh, Tor Browser, and brave package and manage tor; these applications launch, configure and exclusively owned a tor instance.</li>
      <li><strong>system legacy to daemon</strong>: a new option which allows users to connect to and manage an existing system-wide tor daemon, provided they know the control-port password; this configuration is necessary for systems such as Tails</li>
      <li><strong>mock tor client</strong>: this provides a fake in-process tor network to use for testing</li>
      </ul>
      <p>Finally, users need the ability to set various configuration options to use tor or bypass censorship. The bundled legacy tor daemon configuration now has options for the proxy, open firewall ports, pluggable transports, and bridges.</p>
      <h2 id="initial-arti-client-integration">2024-05-25 - Initial <code>arti-client</code> integration</h2>
      <p><a href="https://blog.torproject.org/announcing-arti/">Arti</a> is the Tor Project’s pure-Rust tor implementation. This effort has been on-going for a few years, but it has not been until relatively recently that we could begin the work of adding Arti support to Gosling.</p>
      <p>The first part of this work actually happened last summer with the implementation of the MockTorClient. This client implements the <a href="crates/tor_interface/tor_provider/index.html">TorProvider</a> trait using local sockets and testing the Gosling protocol easier and much more rigorous.</p>
      <p>Once the entire stack was updated to use a generic TorProvider, implementing more became a much easier task. The <a href="crates/tor_interface/arti_client_tor_client/index.html">ArtiClientTorClient</a> integrates and wraps the same backend crates used by the Tor Project’s <a href="https://crates.io/crates/arti">arti crate</a>.</p>
      <p>This tor implementation runs in the same process as Gosling itself, and there is no need for a SOCKS5 proxy or a control port controller. For now, this (and all of the implementations of TorProvider) are gated behind a Rust feature-flag. When building with CMAKE, these flags may be enabled using config options. See the root REAMDE for more details.</p>
      <p>For now, this feature is not available for use in Gosling itself, due to arti’s missing implementation of client authentication. Client auth prevents tor clients from connecting to an onion service, unless they have a particular private key which allows them to decrypt the so-called ‘descriptor’ which contains required routing information. Client auth is used by Gosling’s endpoint servers as a security-in-depth feature to prevent DDOS in the event the onion service id leaks.</p>
      <p>We expect client auth to be implemented upstream in the relatively near future. When it is available, we will do the remaining integration work in the tor-interface crate and plumbing through to cgosling’s C-FFI.</p>
      <h2 id="some-cargo-annoyances">2024-03-27 - Some Cargo Annoyances</h2>
      <p>So in the previous post I mentioned using patchelf to set the <a href="https://en.wikipedia.org/wiki/Soname">SONAME</a> attribute on the libcgosling.so shared library to facilitate proper debian packaging. I further mentioned this was due to an upstream cargo issue. Well, it turns out a similar issue exists for macOS binaries. Rather than playing whack-a-mole and manually fixing every single eventual build target, I took a step back and re-thought my approach and what could be done that would be most maintainable long term.</p>
      <p>The end-result is <a href="https://github.com/blueprint-freespeech/gosling/commit/9ae019efd3c5e5565287b963d09868c4ffaf5891">this</a>.</p>
      <p>To summarise, rather than manually patching and generally futzing with build outputs, I am instead only building cgosling as a static lib, and then building a shared lib using each platforms C tooling. This way, we can lean on CMake to do the heavy lifting when it comes to platform-specific metadata, symbolic-links, naming, etc. Unfortunately there is no standard way using cmake to just build a shared library which exports all of a static libraries public symbols.</p>
      <p>As a result, I’ve had to do some <em>interesting</em> engineering in the cgosling crate using proc macros. Without going into too much detail, we are now building two copies of the cgosling static library, one for direct consumption by downstream projects, and another <code>_impl</code> suffixed copy whose functions have also been renamed to include an <code>_impl</code> suffix. Then, using our existing code-generation pipeline, a cgosling shared library is written which defines public functions with the names found in the generated header, which simply pass-through all arguments to the <code>_impl</code> versions. <em>Hopefully</em> the compilers will optimise away this little overhead but if not I would be surprised if it is actually a big deal.</p>
      <p>This work has allowed me to pretty rapidly and confidently implement both an <a href="https://github.com/blueprint-freespeech/gosling/commit/1435386ba6f826dd73096fa4dbaa4cc8f460af6e">Homebrew Formula</a> for macOS (and Linux) and a <a href="https://github.com/blueprint-freespeech/gosling/commit/b3e59159da503da2d37efd948843681667979ce3">PKGBUILD</a> script for msys2 Windows environments.</p>
      <h2 id="debian-source-packages">2024-02-28 - Debian Source Packages</h2>
      <p>This past week I’ve been diving into the wonderful world of debian packaging. Specifically, constructing a debian source package via CMake which can be used to build the cgosling library from source, and generate both binary and dev packages.</p>
      <p>This exercise has been a bit difficult for a few reasons:</p>
      <ul>
      <li>I knew almost nothing about debian source packing at the start of this process.</li>
      <li>The current debian stable only has rustc version 1.63 in the apt repositories, which means I had to make some changes to remove the rustc 1.66 dependency.</li>
      <li>An upstream bug in cargo (<a href="https://github.com/rust-lang/cargo/issues/5045">rust-lang/cargo#5045 - Support soname for cdylibs</a>) meant following the debian documentation results in deb packages with lintian errors.</li>
      </ul>
      <p>This last issue proved to be the most time consuming. Essentially, the debian tools used to generate a binary package from a source package depend on the presence of the soname metadata field in the provided elf binaries to trigger a call to ldconfig on package installation. This ldconfig step essentially updates some data-store which tells the runtime linker what runtime libraries are available, as well as their versions. However, the rust toolchain does not set this metadata field for cdylib targets like it should. This resulted in libraries which the debian tools did not realise were libraries</p>
      <p>To work around this, I have added a patchelf step which updates this soname field manually for Linux builds. I have also renamed the Linux shared-library target to include full semantic version at the end (libcgosling.so.0.2.1) and added symlinks to this library in the standard format (libcsogling.so and libcgosling.so.0) to play nicely in actual deployments.</p>
      <p>As part of this, I have also moved the crate’s semantic version definition out of its Cargo.toml file, and instead into the CMake part of the build-system. This way, we can generate all the various files (Cargo.toml, debian/control, debian/rules, etc) which need the semantic and major versions.</p>
      <p>With commit <a href="https://github.com/blueprint-freespeech/gosling/commit/7944370a122905b52640d87b5a8e17b2f3e5c53a">5ae906c</a>, we are now able to build debian source packages, and end-users can build binary and dev packages. This is the first step in eventually getting cgosling into debian. Hopefully it will be all the easier by having a properly formatted (with no lintian errors!) source package to start from.</p>
      <h2 id="fosdem">2024-02-01 - FOSDEM!</h2>
      <p>The Blueprint for Free Speech’s Gosling and Ricochet Refresh team is going to Brussels to attend one of the world’s largest free software events – <a href="https://fosdem.org/2024/">FOSDEM 2024</a></p>
      <p>We’ll be sharing our progress on Gosling and <a href="https://ricochetrefresh.net">Ricochet Refresh</a>, as well as exploring what the rest of the community is busy building.</p>
      <p>Drop by if you can to FOSDEM - it’s free!</p>
      <h2 id="no-news-is-good-news">2023-07-04 - No news is good news!</h2>
      <p>Nothing to report here.</p>
      <hr/>
      <footer>
        <p>&copy; 2023-2024 <a href="https://www.blueprintforfreespeech.net">Blueprint for Free Speech</a>. All rights reserved.</p>
      </footer>
    </div>
  </div>
</body>
</html>

